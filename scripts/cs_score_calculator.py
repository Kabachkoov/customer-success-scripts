#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ "–∏–Ω–¥–µ–∫—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è" –∫–ª–∏–µ–Ω—Ç–∞ (Customer Health Score).
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –æ–ø–ª–∞—Ç –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å (NPS).
–ü–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–∏—Ç—å —Ä–∏—Å–∫–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ opportunities –¥–ª—è –∞–ø—Å–µ–π–ª–∞.
"""

def calculate_client_health_score(logins_last_30d, feature_usage, days_since_payment, last_nps):
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∑–¥–æ—Ä–æ–≤—å—è –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç 0 –¥–æ 100.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        logins_last_30d (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–¥–æ–≤ –≤ —Å–∏—Å—Ç–µ–º—É –∑–∞ 30 –¥–Ω–µ–π.
        feature_usage (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–æ–¥—É–∫—Ç–∞.
        days_since_payment (int): –î–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–ø–ª–∞—Ç—ã.
        last_nps (int): –ü–æ—Å–ª–µ–¥–Ω–∏–π Net Promoter Score –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (—à–∫–∞–ª–∞ -10 –¥–æ +10).
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ä–∞—Å—á–µ—Ç–∞, —Å—Ç–∞—Ç—É—Å–æ–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.
    """
    # –í–µ—Å–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ–¥ –ª–æ–≥–∏–∫—É –±–∏–∑–Ω–µ—Å–∞)
    weights = {
        'activity': 0.4,   # –í–µ—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–ª–æ–≥–∏–Ω—ã)
        'usage': 0.3,      # –í–µ—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
        'payment': 0.2,    # –í–µ—Å —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏ –æ–ø–ª–∞—Ç
        'nps': 0.1         # –í–µ—Å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ (NPS)
    }
    
    # 1. –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–ñ–î–û–ô –ú–ï–¢–†–ò–ö–ò –î–û 100 –ë–ê–õ–õ–û–í
    # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: 20+ –ª–æ–≥–∏–Ω–æ–≤ –≤ –º–µ—Å—è—Ü = –∏–¥–µ–∞–ª—å–Ω–æ (100 –±–∞–ª–ª–æ–≤)
    activity_score = min(logins_last_30d / 20, 1) * 100
    
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π: 10+ —Ñ—É–Ω–∫—Ü–∏–π = –∏–¥–µ–∞–ª—å–Ω–æ (100 –±–∞–ª–ª–æ–≤)
    usage_score = min(feature_usage / 10, 1) * 100
    
    # –û–ø–ª–∞—Ç—ã: –µ—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –±—ã–ª–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π - 100 –±–∞–ª–ª–æ–≤, –ø–æ–∑–∂–µ - —Å–Ω–∏–∂–∞–µ—Ç—Å—è
    payment_score = max(0, (90 - days_since_payment) / 90) * 100
    
    # NPS: –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∑ —à–∫–∞–ª—ã -10..+10 –≤ 0..100 –±–∞–ª–ª–æ–≤
    nps_score = ((last_nps + 10) / 20) * 100 if last_nps is not None else 50  # 50 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    # 2. –†–ê–°–ß–ï–¢ –ò–¢–û–ì–û–í–û–ì–û SCORE –° –£–ß–ï–¢–û–ú –í–ï–°–û–í
    total_score = (
        activity_score * weights['activity'] +
        usage_score * weights['usage'] +
        payment_score * weights['payment'] +
        nps_score * weights['nps']
    )
    
    # 3. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô
    if total_score >= 80:
        status = "üíö –ó–î–û–†–û–í–´–ô"
        recommendation = "–ö–ª–∏–µ–Ω—Ç –≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏. –í–æ–∑–º–æ–∂–µ–Ω –∞–ø—Å–µ–π–ª –∏–ª–∏ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ."
    elif total_score >= 60:
        status = "üíõ –°–¢–ê–ë–ò–õ–¨–ù–´–ô"
        recommendation = "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–∞–∫—Ç. –£—Ç–æ—á–Ω–∏—Ç—å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ."
    else:
        status = "üî¥ –†–ò–°–ö–û–í–´–ô"
        recommendation = "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –†–ò–°–ö –û–¢–¢–û–ö–ê! –°—Ä–æ—á–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∑–≤–æ–Ω–æ–∫, –≤—ã—è—Å–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–µ—Ü. —É—Å–ª–æ–≤–∏—è."
    
    # 4. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê
    return {
        "score": round(total_score, 1),
        "status": status,
        "recommendation": recommendation,
        "details": {
            "activity": {
                "value": logins_last_30d,
                "score": round(activity_score),
                "weight": f"{weights['activity']*100:.0f}%"
            },
            "usage": {
                "value": feature_usage,
                "score": round(usage_score),
                "weight": f"{weights['usage']*100:.0f}%"
            },
            "payment": {
                "value": f"{days_since_payment} –¥–Ω. –Ω–∞–∑–∞–¥",
                "score": round(payment_score),
                "weight": f"{weights['payment']*100:.0f}%"
            },
            "nps": {
                "value": last_nps,
                "score": round(nps_score),
                "weight": f"{weights['nps']*100:.0f}%"
            }
        }
    }


def analyze_client_portfolio(clients_data):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –≤—ã–≤–æ–¥–∏—Ç —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        clients_data (list): –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤.
    """
    print("\n" + "="*70)
    print("üìä –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ó–î–û–†–û–í–¨–Ø –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û –ü–û–†–¢–§–ï–õ–Ø")
    print("="*70)
    
    portfolio_stats = {
        "üíö –ó–î–û–†–û–í–´–ô": 0,
        "üíõ –°–¢–ê–ë–ò–õ–¨–ù–´–ô": 0, 
        "üî¥ –†–ò–°–ö–û–í–´–ô": 0
    }
    
    for client in clients_data:
        # –†–∞—Å—á–µ—Ç health score –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        result = calculate_client_health_score(
            logins_last_30d=client["logins"],
            feature_usage=client["features"],
            days_since_payment=client["days_payment"],
            last_nps=client.get("nps")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º .get() –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è NPS
        )
        
        # –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        portfolio_stats[result["status"]] += 1
        
        # –í—ã–≤–æ–¥ –¥–µ—Ç–∞–ª–µ–π –ø–æ –∫–ª–∏–µ–Ω—Ç—É
        print(f"\n{'‚îÄ'*40}")
        print(f"üë§ –ö–õ–ò–ï–ù–¢: {client['name']}")
        print(f"üìç Health Score: {result['score']}/100 ‚Üí {result['status']}")
        print(f"üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: {result['recommendation']}")
        
        # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
        print(f"\n   –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–ª–æ–≤:")
        for metric, data in result["details"].items():
            metric_name_ru = {
                "activity": "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
                "usage": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ", 
                "payment": "–û–ø–ª–∞—Ç—ã",
                "nps": "–õ–æ—è–ª—å–Ω–æ—Å—Ç—å (NPS)"
            }[metric]
            print(f"   ‚Ä¢ {metric_name_ru}: {data['value']} ‚Üí {data['score']} –±–∞–ª–ª–æ–≤ (–≤–µ—Å {data['weight']})")
    
    # 5. –°–í–û–î–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ü–û–†–¢–§–ï–õ–Æ
    print("\n" + "="*70)
    print("üìà –°–í–û–î–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ü–û–†–¢–§–ï–õ–Æ:")
    print("="*70)
    
    total_clients = len(clients_data)
    for status, count in portfolio_stats.items():
        percentage = (count / total_clients) * 100 if total_clients > 0 else 0
        print(f"{status}: {count} –∫–ª–∏–µ–Ω—Ç–æ–≤ ({percentage:.1f}%)")
    
    # –†–∞—Å—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ health score –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é
    average_score = sum(
        calculate_client_health_score(
            c["logins"], c["features"], c["days_payment"], c.get("nps")
        )["score"] for c in clients_data
    ) / total_clients if total_clients > 0 else 0
    
    print(f"\nüìä –°—Ä–µ–¥–Ω–∏–π Health Score –ø–æ –ø–æ—Ä—Ç—Ñ–µ–ª—é: {average_score:.1f}/100")
    
    # –ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    print(f"\nüéØ –ö–õ–Æ–ß–ï–í–´–ï –î–ï–ô–°–¢–í–ò–Ø –ù–ê –ù–ï–î–ï–õ–Æ:")
    if portfolio_stats["üî¥ –†–ò–°–ö–û–í–´–ô"] > 0:
        print(f"   ‚Ä¢ –í—ã–¥–µ–ª–∏—Ç—å {portfolio_stats['üî¥ –†–ò–°–ö–û–í–´–ô']} —Ä–∏—Å–∫–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç")
    if portfolio_stats["üíõ –°–¢–ê–ë–ò–õ–¨–ù–´–ô"] > 3:
        print(f"   ‚Ä¢ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è {portfolio_stats['üíõ –°–¢–ê–ë–ò–õ–¨–ù–´–ô']} —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤")
    if portfolio_stats["üíö –ó–î–û–†–û–í–´–ô"] > 2:
        print(f"   ‚Ä¢ –ü—Ä–æ–≤–µ—Å—Ç–∏ –¥–µ–º–æ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è {portfolio_stats['üíö –ó–î–û–†–û–í–´–ô']} –∑–¥–æ—Ä–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤")
    
    print("="*70)


# =================== –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø ===================
if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: –ø–æ—Ä—Ç—Ñ–µ–ª—å –∏–∑ 5 –∫–ª–∏–µ–Ω—Ç–æ–≤
    example_portfolio = [
        {
            "name": "–û–û–û '–¢–µ—Ö–Ω–æ–ü—Ä–æ—Ñ–∏—Ç'",
            "logins": 25,           # 25 –≤—Ö–æ–¥–æ–≤ –∑–∞ 30 –¥–Ω–µ–π
            "features": 8,          # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç 8 —Ñ—É–Ω–∫—Ü–∏–π
            "days_payment": 30,     # –ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–ª–∞—Ç–∞ 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
            "nps": 8                # –î–∞–≤–∞–ª –æ—Ü–µ–Ω–∫—É +8 –ø–æ NPS
        },
        {
            "name": "–ò–ü –°–∏–¥–æ—Ä–æ–≤ –ê.–í.",
            "logins": 5,            # –ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            "features": 2,          # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ 2 —Ñ—É–Ω–∫—Ü–∏–∏
            "days_payment": 120,    # –ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–ª–∞—Ç–∞ 4 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥
            "nps": -3               # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π NPS
        },
        {
            "name": "–ì–ö '–°—Ç—Ä–æ–π–ì—Ä–∞–¥'",
            "logins": 15,           # –£–º–µ—Ä–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            "features": 12,         # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π
            "days_payment": 45,     # –û–ø–ª–∞—Ç–∞ 1.5 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥
            "nps": 9                # –í—ã—Å–æ–∫–∏–π NPS
        },
        {
            "name": "–û–û–û '–í–µ–∫—Ç–æ—Ä–ü–ª—é—Å'",
            "logins": 18,
            "features": 6,
            "days_payment": 60,
            "nps": 5
        },
        {
            "name": "–ò–ü –ö–æ–∑–ª–æ–≤–∞ –ú.–ò.",
            "logins": 2,            # –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            "features": 1,          # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
            "days_payment": 150,    # –î–æ–ª–≥–æ –Ω–µ –ø–ª–∞—Ç–∏–ª
            "nps": None             # NPS –Ω–µ –∏–∑–º–µ—Ä—è–ª—Å—è
        }
    ]
    
    # –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    analyze_client_portfolio(example_portfolio)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    print("\n" + "="*70)
    print("üß™ –ü–†–ò–ú–ï–† –†–ê–°–ß–ï–¢–ê –î–õ–Ø –û–î–ù–û–ì–û –ö–õ–ò–ï–ù–¢–ê:")
    print("="*70)
    
    single_client_result = calculate_client_health_score(
        logins_last_30d=25,
        feature_usage=8,
        days_since_payment=30,
        last_nps=8
    )
    
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {single_client_result['score']}/100 - {single_client_result['status']}")
    print(f"–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: {single_client_result['recommendation']}")
    print("="*70)
